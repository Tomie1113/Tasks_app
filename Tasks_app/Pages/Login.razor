@page "/login"
@inject Database Db
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="x-container">
    <div class="login-page-container">
        <div class="login-form">
            <h2 style="text-align:center; margin-bottom:10px;">Вход администратора</h2>

            @if (!Success_enter)
            {
                <label>Логин</label>
                <input type="text" @bind="Username" />

                <label>Пароль</label>
                <input type="password" @bind="Password" />

                <button @onclick="Login_">Войти</button>

                @if (!string.IsNullOrEmpty(Error))
                {
                    <p style="color:red; text-align:center; margin-top:10px;">@Error</p>
                }
            }
            else
            {
                <p style="color:limegreen; text-align:center; margin-top:10px;">
                    Вы уже вошли как администратор.
                </p>
            }
        </div>
    </div>
</div>

@code {
    private string Username = "";
    private string Password = "";
    private string Error = "";
    private bool Success_enter = false;
    private bool _checkedAdmin = false; // чтобы не крутиться в цикле

    private async Task Login_()
    {
        string hash = ComputeSha256(Password);

        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        string sql = "SELECT id FROM users WHERE username = @u AND password_hash = @p LIMIT 1";

        using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("@u", Username);
        cmd.Parameters.AddWithValue("@p", hash);

        var result = await cmd.ExecuteScalarAsync();

        if (result != null)
        {
            Error = "";
            Success_enter = true;

            // ставим статус администратора
            await JS.InvokeVoidAsync("sessionStorage.setItem", "is_admin", "1");
        }
        else
        {
            Error = "Неверный логин или пароль.";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_checkedAdmin)
        {
            _checkedAdmin = true;

            // если уже залогинен в этом браузере — сразу показываем зелёную надпись
            var flag = await JS.InvokeAsync<string>("sessionStorage.getItem", "is_admin");
            if (flag == "1")
            {
                Success_enter = true;
                Error = "";
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private string ComputeSha256(string raw)
    {
        using var sha = System.Security.Cryptography.SHA256.Create();
        var bytes = System.Text.Encoding.UTF8.GetBytes(raw);
        var hash = sha.ComputeHash(bytes);
        return BitConverter.ToString(hash).Replace("-", "").ToLower();
    }
}
