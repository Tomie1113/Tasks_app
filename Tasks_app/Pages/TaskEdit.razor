@page "/tasks/edit/{Id:int}"

@using Npgsql
@inject IJSRuntime JS
@inject Database Db
@inject NavigationManager Nav
<div class="task-add">
    <h1>@(Id == 0 ? "Новая задача" : "Редактирование задачи")</h1>


        <input @bind="NewTask.Name" type="text" placeholder="Название" />
        <textarea @bind="NewTask.Statement" placeholder="Условие"></textarea>
        <textarea @bind="NewTask.SolutionIdea" placeholder="Идея решения"></textarea>
        <input @bind="NewTask.PolygonUrl" type="text" placeholder="Polygon URL" />

        <div style="display:flex; gap:15px;">
            <label><input type="checkbox" @bind="NewTask.IsCF" /> CF</label>
            <label><input type="checkbox" @bind="NewTask.IsYandex" /> Yandex</label>
        </div>

        <input type="number" @bind="NewTask.Difficulty" min="1" max="10" placeholder="Сложность" />
        <textarea @bind="NewTask.Notes" placeholder="Заметки"></textarea>
<label>Теги:</label>
<div class="combo-wrapper">
    <div class="combo-multi" @onclick="ToggleTagsDropdown">
        <span>@GetSelectedTagsText()</span>
        <span class="arrow">▼</span>
    </div>

    @if (IsTagsDropdownOpen)
    {
        <div class="combo-dropdown">
            @foreach (var t in Tags)
            {
                <label class="combo-item">
                    @* строка с чекбоксом *@
                    <input type="checkbox"
                           checked="@SelectedTags.Contains(t.IdTag)"
                           @onchange="args => OnTagToggle(t.IdTag, (bool)args.Value)" />
                    <span>@t.Name</span> @* название тега *@
                </label>
            }

            <button type="button"
                    class="close-drop"
                    @onclick="CloseTagsDropdown">Готово</button>
        </div>
    }
</div>


<label>Контексты:</label>
<div class="combo-wrapper">
    <div class="combo-multi" @onclick="ToggleContextsDropdown">
        <span>@GetSelectedContextsText()</span>
        <span class="arrow">▼</span>
    </div>

    @if (IsContextsDropdownOpen)
    {
        <div class="combo-dropdown">
            @foreach (var c in Contests)
            {
                <label class="combo-item">
                    @* строка с чекбоксом *@
                    <input type="checkbox"
                           checked="@SelectedContexts.Contains(c.IdContest)"
                           @onchange="args => OnContextToggle(c.IdContest, (bool)args.Value)" />
                    <span>@c.Name</span> @* название контекста *@
                </label>
            }

            <button type="button"
                    class="close-drop"
                    @onclick="CloseContextsDropdown">Готово</button>
        </div>
    }
</div>


        <button @onclick="Save">Сохранить</button>
        <button @onclick="Cancel">Отмена</button>

</div>
@code {
    [Parameter]
    public int Id { get; set; }

    public class NewTaskModel
    {
        public string Name { get; set; } = "";
        public string Statement { get; set; } = "";
        public string SolutionIdea { get; set; } = "";
        public string PolygonUrl { get; set; } = "";
        public bool IsCF { get; set; }
        public bool IsYandex { get; set; }
        public int Difficulty { get; set; }
        public string Notes { get; set; } = "";
        public int IdContext { get; set; }
    }

    public class TagRef
    {
        public int IdTag { get; set; }
        public string Name { get; set; } = "";
    }

    public class ContestRef
    {
        public int IdContest { get; set; }
        public string Name { get; set; } = "";
    }
    private bool IsTagsDropdownOpen = false;       // открыт ли дропдаун тегов
private bool IsContextsDropdownOpen = false;   // открыт ли дропдаун контекстов

private void ToggleTagsDropdown()              // открыть/закрыть список тегов
{
    IsTagsDropdownOpen = !IsTagsDropdownOpen;  // инвертируем флаг
}

private void CloseTagsDropdown()               // закрыть список тегов
{
    IsTagsDropdownOpen = false;                // просто закрываем
}

private void ToggleContextsDropdown()          // открыть/закрыть список контекстов
{
    IsContextsDropdownOpen = !IsContextsDropdownOpen; // инвертируем флаг
}

private void CloseContextsDropdown()           // закрыть список контекстов
{
    IsContextsDropdownOpen = false;            // закрываем
}

private string GetSelectedTagsText()           // текст для кнопки тегов
{
    if (SelectedTags.Count == 0)               // если ничего не выбрано
        return "Не выбрано";                  // показываем заглушку

    return string.Join(", ",                  // склеиваем названия
        Tags.Where(t => SelectedTags.Contains(t.IdTag)) // фильтруем по выбранным id
            .Select(t => t.Name));            // берём имена
}

private string GetSelectedContextsText()       // текст для кнопки контекстов
{
    if (SelectedContexts.Count == 0)          // если ни одного контекста нет
        return "Не выбрано";                  // показываем заглушку

    return string.Join(", ",                  // склеиваем имена
        Contests.Where(c => SelectedContexts.Contains(c.IdContest)) // только выбранные
                .Select(c => c.Name));        // берём названия
}
    private NewTaskModel NewTask = new();
    private List<TagRef> Tags = new();
    private List<ContestRef> Contests = new();
    private HashSet<int> SelectedTags = new();
    private HashSet<int> SelectedContexts = new();
    private bool IsAdmin;
    protected override async Task OnInitializedAsync()
    {    // получить токен администратора
        var token = await JS.InvokeAsync<string>("sessionStorage.getItem", "is_admin");
        IsAdmin = (token == "1");
        if (!IsAdmin)
        {
            Nav.NavigateTo("/tasks");
            return;
        }

        await LoadRefsAsync();
        if (Id > 0)
            await LoadTaskAsync(Id);
    }

    private async Task LoadRefsAsync()
    {
        using var conn = Db.GetConnection();
        await conn.OpenAsync();
        //теги
        {
            const string sql = "SELECT id_tag, name_tag FROM tags ORDER BY name_tag";
            using var cmd = new NpgsqlCommand(sql, conn);
            using var r = await cmd.ExecuteReaderAsync();

            Tags.Clear();
            while (await r.ReadAsync())
            {
                Tags.Add(new TagRef
                {
                    IdTag = r.GetInt32(0),
                    Name = r.GetString(1)
                });
            }

            r.Close();
        }
        //контесты
        {
            const string sql = "SELECT id_contest, name_contest FROM contests ORDER BY name_contest";
            using var cmd = new NpgsqlCommand(sql, conn);
            using var r = await cmd.ExecuteReaderAsync();

            Contests.Clear();
            while (await r.ReadAsync())
            {
                Contests.Add(new ContestRef
                {
                    IdContest = r.GetInt32(0),
                    Name = r.GetString(1)
                });
            }
        }
    }

    //задачи
    private async Task LoadTaskAsync(int id)
    {
        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        const string sqlTask = @"
            SELECT
                name,
                statement,
                solution_idea,
                polygon_url,
                is_prepared_for_codeforces,
                is_prepared_for_yandex,
                COALESCE(difficulty, 0),
                notes,
                COALESCE(id_context, 0)
            FROM tasks
            WHERE id_task = :id;
        ";

        using (var cmd = new NpgsqlCommand(sqlTask, conn))
        {
            cmd.Parameters.AddWithValue("id", id);

            using var r = await cmd.ExecuteReaderAsync();

            if (await r.ReadAsync())
            {
                NewTask.Name = r.IsDBNull(0) ? "" : r.GetString(0);
                NewTask.Statement = r.IsDBNull(1) ? "" : r.GetString(1);
                NewTask.SolutionIdea = r.IsDBNull(2) ? "" : r.GetString(2);
                NewTask.PolygonUrl = r.IsDBNull(3) ? "" : r.GetString(3);
                NewTask.IsCF = !r.IsDBNull(4) && r.GetBoolean(4);
                NewTask.IsYandex = !r.IsDBNull(5) && r.GetBoolean(5);
                NewTask.Difficulty = r.IsDBNull(6) ? 0 : r.GetInt32(6);
                NewTask.Notes = r.IsDBNull(7) ? "" : r.GetString(7);
                NewTask.IdContext = r.IsDBNull(8) ? 0 : r.GetInt32(8);
            }
            else
            {
                Nav.NavigateTo("/tasks");
                return;
            }
        }

        SelectedTags.Clear();

        //выбранные теги
        const string sqlTags = "SELECT id_tag FROM task_tags WHERE id_task = :id";
        using (var cmdTags = new NpgsqlCommand(sqlTags, conn))
        {
            cmdTags.Parameters.AddWithValue("id", id);

            using var rt = await cmdTags.ExecuteReaderAsync();
            while (await rt.ReadAsync())
                SelectedTags.Add(rt.GetInt32(0));
        }

        //выбранные контесты
        SelectedContexts.Clear();

        const string sqlCtx = "SELECT id_contest FROM task_contests WHERE id_task = :id";
        using (var cmdCtx = new NpgsqlCommand(sqlCtx, conn))
        {
            cmdCtx.Parameters.AddWithValue("id", id);

            using var rc = await cmdCtx.ExecuteReaderAsync();
            while (await rc.ReadAsync())
                SelectedContexts.Add(rc.GetInt32(0));
        }
    }

    private void OnTagToggle(int tagId, bool isChecked)
    {
        if (isChecked)
            SelectedTags.Add(tagId);
        else
            SelectedTags.Remove(tagId);
    }

    private void OnContextToggle(int ctxId, bool isChecked)
    {
        if (isChecked)
            SelectedContexts.Add(ctxId);
        else
            SelectedContexts.Remove(ctxId);
    }


    //кнопки
    private async Task Save()
    {
        if (!IsAdmin)
            return;

        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        int taskId;

        if (Id == 0)
        {
            //добавление
            const string insertSql = @"
                INSERT INTO tasks
                    (name, statement, solution_idea, polygon_url,
                     is_prepared_for_codeforces, is_prepared_for_yandex,
                     difficulty, notes, id_context)
                VALUES
                    (:n, :st, :si, :p, :cf, :ya, :d, :no, :ctx)
                RETURNING id_task;
            ";

            using var cmd = new NpgsqlCommand(insertSql, conn);
            cmd.Parameters.AddWithValue("n", NewTask.Name);
            cmd.Parameters.AddWithValue("st", NewTask.Statement);
            cmd.Parameters.AddWithValue("si", NewTask.SolutionIdea);
            cmd.Parameters.AddWithValue("p", NewTask.PolygonUrl);
            cmd.Parameters.AddWithValue("cf", NewTask.IsCF);
            cmd.Parameters.AddWithValue("ya", NewTask.IsYandex);
            cmd.Parameters.AddWithValue("d", NewTask.Difficulty);
            cmd.Parameters.AddWithValue("no", NewTask.Notes);
            cmd.Parameters.AddWithValue("ctx",
                NewTask.IdContext == 0 ? DBNull.Value : NewTask.IdContext);

            taskId = Convert.ToInt32(await cmd.ExecuteScalarAsync());
        }
        else
        {
            //обновление
            const string updateSql = @"
                UPDATE tasks
                SET
                    name = :n,
                    statement = :st,
                    solution_idea = :si,
                    polygon_url = :p,
                    is_prepared_for_codeforces = :cf,
                    is_prepared_for_yandex = :ya,
                    difficulty = :d,
                    notes = :no,
                    id_context = :ctx
                WHERE id_task = :id;
            ";

            using var cmd = new NpgsqlCommand(updateSql, conn);
            cmd.Parameters.AddWithValue("n", NewTask.Name);
            cmd.Parameters.AddWithValue("st", NewTask.Statement);
            cmd.Parameters.AddWithValue("si", NewTask.SolutionIdea);
            cmd.Parameters.AddWithValue("p", NewTask.PolygonUrl);
            cmd.Parameters.AddWithValue("cf", NewTask.IsCF);
            cmd.Parameters.AddWithValue("ya", NewTask.IsYandex);
            cmd.Parameters.AddWithValue("d", NewTask.Difficulty);
            cmd.Parameters.AddWithValue("no", NewTask.Notes);
            cmd.Parameters.AddWithValue("ctx",
                NewTask.IdContext == 0 ? DBNull.Value : NewTask.IdContext);
            cmd.Parameters.AddWithValue("id", Id);

            await cmd.ExecuteNonQueryAsync();
            taskId = Id;
        }

        //перезапись тегов
        {
            const string delSql = "DELETE FROM task_tags WHERE id_task = :t";
            using (var delCmd = new NpgsqlCommand(delSql, conn))
            {
                delCmd.Parameters.AddWithValue("t", taskId);
                await delCmd.ExecuteNonQueryAsync();
            }

            const string insSql = "INSERT INTO task_tags (id_task, id_tag) VALUES (:t, :g)";
            foreach (var tagId in SelectedTags)
            {
                using var insCmd = new NpgsqlCommand(insSql, conn);
                insCmd.Parameters.AddWithValue("t", taskId);
                insCmd.Parameters.AddWithValue("g", tagId);
                await insCmd.ExecuteNonQueryAsync();
            }
        }

        //перезапись контестов
        {
            const string delSql = "DELETE FROM task_contests WHERE id_task = :t";
            using (var delCmd = new NpgsqlCommand(delSql, conn))
            {
                delCmd.Parameters.AddWithValue("t", taskId);
                await delCmd.ExecuteNonQueryAsync();
            }

            const string insSql = "INSERT INTO task_contests (id_task, id_contest) VALUES (:t, :c)";
            foreach (var ctxId in SelectedContexts)
            {
                using var insCmd = new NpgsqlCommand(insSql, conn);
                insCmd.Parameters.AddWithValue("t", taskId);
                insCmd.Parameters.AddWithValue("c", ctxId);
                await insCmd.ExecuteNonQueryAsync();
            }
        }

        Nav.NavigateTo("/tasks");
    }

    private void Cancel()
    {
        Nav.NavigateTo("/tasks");
    }
}
