@page "/tags"
@inject Database Db
@inject AdminSession Admin
@inject IJSRuntime JS

<div class="x-container" @ref="selfRef">

    <h1 style="text-align:center; width:100%;">Теги</h1>

    @if (Tags_ == null)
    {
        <p>Загрузка...</p>
    }
    else if (Tags_.Count == 0)
    {
        <p>Теги отсутствуют.</p>
    }
    else
    {
        <div class="filters-row">

            <div class="filter-block">
                <label class="filter-label">Поиск</label>
                <input @bind="FilterName"
                       type="text"
                       placeholder="Название тега"
                       class="filter-input filter-name" />

            </div>

            <div class="filter-buttons">
                <button @onclick="ApplyFilters" class="btn-primary">Фильтровать</button>
                <button @onclick="ResetFilters" class="btn-secondary">Сбросить</button>
            </div>

        </div>
        
        <table class="x-table">
            <thead>
                <tr>
                    <th>Название</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var t in Tags_)
                {
                    <tr @key="t.IdTag">
                        <td id="tag-@t.IdTag">@t.NameTag</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (Admin.IsAdmin)
    {
        <div class="tag-add">
            <input @bind="tagInput" type="text" placeholder="Новый тег" />
            <button @onclick="TagsAdd">Добавить</button>
        </div>
    }
    <div id="tag-delete-dialog"
         style="display:none; position:fixed; inset:0;
            background:rgba(0,0,0,0.45); backdrop-filter:blur(4px);
            align-items:center; justify-content:center; z-index:9999;">

        <div style="background:var(--surface); padding:20px; border-radius:12px; width:260px;
                font-family:var(--font-main); text-align:center;
                border:1px solid var(--surface-border); backdrop-filter:blur(16px);">

            <div style="margin-bottom:15px; font-size:var(--fs-table); color:var(--grey-50);">
                Удалить тег?
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">

                <button id="tag-del-yes"
                        style="padding:10px 14px; border-radius:6px; cursor:pointer;">
                    Удалить
                </button>

                <button id="tag-del-no"
                        style="padding:10px 14px; border-radius:6px; cursor:pointer;">
                    Отмена
                </button>

            </div>
        </div>
    </div>



</div>

@code {
    private ElementReference selfRef;
    private DotNetObjectReference<Tags> selfObj;

    private bool IsEditing = false;
    private string FilterName = "";

    private static Tags Instance;

    protected override void OnInitialized()
    {
        Instance = this;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Tags_ == null)
            return;

        foreach (var t in Tags_)
            await JS.InvokeVoidAsync("TagsInterop.bindRowEventsById", t.IdTag);
        if (firstRender)
        {
            selfObj = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("TagsInterop.setComponent", selfObj);
        }

    }
    
    private async Task ApplyFilters()
    {
        await LoadTagsAsync();

        if (!string.IsNullOrWhiteSpace(FilterName))
        {
            string f = FilterName.ToLower();
            Tags_ = Tags_.Where(t =>
                (t.NameTag?.ToLower().Contains(f) ?? false)).ToList();
        }
        StateHasChanged();
    }

    private async Task ResetFilters()
    {
        FilterName = "";
        await LoadTagsAsync();
        StateHasChanged();
    }

    //JS
    [JSInvokable]
    public void StartEdit()
    {
        IsEditing = true;
    }

    [JSInvokable]
    public async Task RequestTagDelete(int id)
    {
        if (Admin.IsAdmin)
            await DeleteTag(id);
    }

    [JSInvokable]
    public async Task RequestTagRename(int id, string newName)
    {
        if (Admin.IsAdmin)
            await RenameTag(id, newName);
    }


    //переименование
    
    public async Task RenameTag(int id, string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            await JS.InvokeVoidAsync("alert", "Название не может быть пустым");
            return;
        }

        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        string sql = "UPDATE tags SET name_tag = :name WHERE id_tag = :id";

        using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("name", name);
        cmd.Parameters.AddWithValue("id", id);
        await cmd.ExecuteNonQueryAsync();

        IsEditing = false;
        
        await LoadTagsAsync();
        await InvokeAsync(StateHasChanged);

    }

    //удаление
    public async Task DeleteTag(int id)
    {
        try
        {
            //проверка
            using var conn = Db.GetConnection();
            await conn.OpenAsync();
            string checkSql = "SELECT COUNT(*) FROM task_tags WHERE id_tag = :id";

            using var checkCmd = new Npgsql.NpgsqlCommand(checkSql, conn);
            checkCmd.Parameters.AddWithValue("id", id);

            int inUse = Convert.ToInt32(await checkCmd.ExecuteScalarAsync());

            if (inUse > 0)
            {
                await JS.InvokeVoidAsync("alert", "Тег используется в задачах. Удаление невозможно.");
                return;
            }

            //удаление
            string sql = "DELETE FROM tags WHERE id_tag = :id";

            using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("id", id);

            int rows = await cmd.ExecuteNonQueryAsync();
            
            await LoadTagsAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine(ex.Message);
            throw;
        }
    }

    //инициализация
    private List<TagItem>? Tags_;
    private string tagInput;

    protected override async Task OnInitializedAsync()
    {
        await LoadTagsAsync();
    }

    private async Task LoadTagsAsync()
    {
        if (IsEditing)
        {
            return;
        }

        Tags_ = new();

        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        string sql = @"SELECT id_tag, name_tag FROM tags ORDER BY id_tag";
        using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
        using var reader = await cmd.ExecuteReaderAsync();

        while (await reader.ReadAsync())
        {
            Tags_.Add(new TagItem
                {
                    IdTag = reader.GetInt32(0),
                    NameTag = reader.GetString(1)
                });
        }
    }
    
    //добавление
    private async Task TagsAdd()
    {
        if (string.IsNullOrWhiteSpace(tagInput))
        {
            return;
        }

        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        string sql = @"INSERT INTO tags (name_tag) VALUES (:name)";
        using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("name", tagInput);

        await cmd.ExecuteNonQueryAsync();
        await LoadTagsAsync();
        tagInput = "";
    }
    
    public class TagItem
    {
        public int IdTag { get; set; }
        public string NameTag { get; set; } = string.Empty;
    }
}
