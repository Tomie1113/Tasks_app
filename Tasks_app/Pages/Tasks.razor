@page "/tasks"
@using QuestPDF.Fluent
@using QuestPDF.Infrastructure
@using QuestPDF.Helpers

@inject Database Db
@inject IJSRuntime JS
@inject NavigationManager Nav


<div class="x-container">

    <h1 style="text-align:center; width:100%;">Задачи</h1>
    <div class="filters-panel">

        <div class="filters-row">

            <div class="filter-block">
                <label class="filter-label">Поиск</label>
                <input @bind="FilterText"
                       type="text"
                       placeholder="Название / условие"
                       class="filter-input filter-name" />

            </div>
            <div class="filter-block tags-filter">

                <label class="filter-label">Теги (несколько)</label>

  
                <div class="combo-multi" @onclick="ToggleTags">
       
                    <span>@GetSelectedTagsText()</span> 
                    <span class="arrow">▼</span>       
                </div>

                @if (IsTagsOpen)
                {
                    <div class="combo-dropdown">
                       
                        @foreach (var t in Tags)
                        {
                            <label class="combo-item">
                              
                                <input type="checkbox"
                                       checked="@SelectedTags.Contains(t.IdTag)"
                                       @onchange="@(() => ToggleTag(t.IdTag))" /> 
                                <span>@t.Name</span>
                            </label>
                        }

                        <button type="button"
                                class="close-drop"
                                @onclick="CloseTags">
                            Готово
                        </button> 
                    </div>
                }
            </div>




            <div class="filter-block">
                <label class="filter-label">Контекст</label>
                <select @bind="FilterContext" class="filter-input">
                    <option value="0">Все контексты</option>
                    @foreach (var c in Contests)
                    {
                        <option value="@c.IdContest">@c.Name</option>
                    }
                </select>
            </div>

            <div class="filter-block">
                <label class="filter-label">Сложность</label>
                <select @bind="FilterDifficulty" class="filter-input">
                    <option value="0">Любая сложность</option>
                    @foreach (var d in Difficulty)
                    {
                        <option value="@d">@d</option>
                    }
                </select>
            </div>

            <div class="filter-buttons">
                <button @onclick="ApplyFilters" class="btn-primary">Фильтровать</button>
                <button @onclick="ResetFilters" class="btn-secondary">Сбросить</button>
            </div>

        </div>

    </div>


    @if (Tasks_ == null)
    {
        <p>Загрузка...</p>
    }
    else if (Tasks_.Count == 0)
    {
        <p>Задачи отсутствуют.</p>
    }
    else
    {
        <div class="table-scroll">
            <table class="x-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Условие</th>
                        <th>Идея</th>
                        <th>Polygon</th>
                        <th>CF</th>
                        <th>Yandex</th>
                        <th>Сложность</th>
                        <th>Заметки</th>
                        <th>Теги</th>
                        <th>Контекст</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var t in Tasks_)
                    {
                        <tr id="task-row-@t.IdTask" @key="t.IdTask">
                            <td>@t.Name</td>
                            <td>@t.Statement</td>
                            <td>@t.SolutionIdea</td>
                            <td>@t.PolygonUrl</td>
                            <td>@t.IsPreparedCF</td>
                            <td>@t.IsPreparedYandex</td>
                            <td>@t.Difficulty</td>
                            <td>@t.Notes</td>
                            <td>@(string.IsNullOrEmpty(t.Tags) ? "—" : t.Tags)</td>
                            <td>@(string.IsNullOrEmpty(t.Contexts) ? "—" : t.Contexts)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }


        <div class="filter-buttons">
                @if (IsAdmin)
            {
            <button @onclick="GoToCreateTask">Добавить задачу</button>
             }
            <button @onclick="ExportTasksToPdf">Экспорт в PDF</button>
        </div>
    @if (IsAdmin)
    {
    <div id="task-delete-dialog"
         style="display:none; position:fixed; inset:0;
            background:rgba(0,0,0,0.45); backdrop-filter:blur(4px);
            align-items:center; justify-content:center; z-index:9999;">

        <div style="background:var(--surface); padding:20px; border-radius:12px; width:260px;
                font-family:var(--font-main); text-align:center;
                border:1px solid var(--surface-border); backdrop-filter:blur(16px);">

            <div style="margin-bottom:15px; font-size:var(--fs-table); color:var(--grey-50);">
                Удалить задачу?
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">

                <button id="task-del-yes"
                        style="padding:10px 14px; border-radius:6px; cursor:pointer;
                           background: linear-gradient(90deg, #7a3a3a, #8c2f2f);
                           border: 1px solid rgba(200, 80, 80, 0.25);
                           color: var(--grey-50); font-size: var(--fs-table); font-weight: var(--fw-bold);
                           transition: 0.25s var(--ease-1);">
                    Удалить
                </button>

                <button id="task-del-no"
                        style="padding:10px 14px; border-radius:6px; cursor:pointer;
                           background: rgba(255,255,255,0.05);
                           border: 1px solid rgba(255,255,255,0.12);
                           color: var(--grey-200); font-size: var(--fs-table); font-weight: var(--fw-medium);
                           transition: 0.25s var(--ease-1);">
                    Отмена
                </button>

            </div>
        </div>
    </div>
    }

</div>

@code {
    private HashSet<int> SelectedContexts = new();

    private string FilterText = "";
    private int FilterTag = 0;
    private int FilterContext = 0;
    private int FilterDifficulty = 0;

    private DotNetObjectReference<Tasks> selfObj;

    private NewTaskModel NewTask = new();
    private HashSet<int> SelectedTags = new();

    public class NewTaskModel
    {
        public string Name { get; set; } = "";
        public string Statement { get; set; } = "";
        public string SolutionIdea { get; set; } = "";
        public string PolygonUrl { get; set; } = "";
        public bool IsCF { get; set; }
        public bool IsYandex { get; set; }
        public int Difficulty { get; set; }
        public string Notes { get; set; } = "";
        public int IdContext { get; set; }
    }

    public class TaskItem
    {
        public int IdTask { get; set; }
        public string Name { get; set; } = "";
        public string Statement { get; set; } = "";
        public string SolutionIdea { get; set; } = "";
        public string PolygonUrl { get; set; } = "";
        public bool IsPreparedCF { get; set; }
        public bool IsPreparedYandex { get; set; }
        public int? Difficulty { get; set; }
        public string Notes { get; set; } = "";
        public string Tags { get; set; } = "";
        public string Contexts { get; set; } = "";

    }

    public class TagRef
    {
        public int IdTag { get; set; }
        public string Name { get; set; } = "";
    }

    public class ContestRef
    {
        public int IdContest { get; set; }
        public string Name { get; set; } = "";
    }

    private List<TagRef> Tags = new();
    private List<ContestRef> Contests = new();
    private List<TaskItem>? Tasks_;
    private List<int?> Difficulty = new();

    public Tasks()
    {
        QuestPDF.Settings.License = LicenseType.Community;
    }
    private bool BindTag(int id)
    {
        return SelectedTags.Contains(id);
    }

    private void BindTag(int id, bool value)
    {
        if (value)
            SelectedTags.Add(id);
        else
            SelectedTags.Remove(id);
    }

    private bool DropdownOpen = false;

private void ToggleDropdown()
{
    DropdownOpen = !DropdownOpen;
}

private string GetSelectedTagsText()
{
    if (SelectedTags.Count == 0)
        return "Не выбрано";

    return string.Join(", ",
        Tags.Where(t => SelectedTags.Contains(t.IdTag))
            .Select(t => t.Name)
    );
}

    //pdf
    public async Task ExportTasksToPdf()
    {
        if (Tasks_ == null || Tasks_.Count == 0)
            return;

        using var ms = new MemoryStream();

        var doc = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Margin(20);
                page.Size(PageSizes.A4.Landscape());

                page.Header()
                    .PaddingBottom(10)
                    .AlignCenter()
                    .Text("Отчёт по задачам")
                        .FontSize(18)
                        .Bold();

                page.Content().Table(table =>
                {
                    table.ColumnsDefinition(columns =>
                    {
                        columns.RelativeColumn(2);  // Название
                        columns.RelativeColumn(3);  // Условие
                        columns.RelativeColumn(3);  // Идея
                        columns.RelativeColumn(2);  // Polygon
                        columns.RelativeColumn(1);  // CF
                        columns.RelativeColumn(1);  // Yandex
                        columns.RelativeColumn(1);  // Сложность
                        columns.RelativeColumn(2);  // Заметки
                        columns.RelativeColumn(2);  // Теги
                        columns.RelativeColumn(2);  // Контексты
                    });

                    IContainer Cell(IContainer container) =>
                        container
                            .Border(0.5f)
                            .BorderColor("#000")
                            .Padding(4);

                    table.Header(header =>
                    {
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Название").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Условие").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Идея решения").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Polygon URL").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("CF").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Yandex").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Сложность").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Заметки").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Теги").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Контексты").Bold();
                    });
                    foreach (var t in Tasks_)
                    {
                        table.Cell().Element(Cell).Text(t.Name ?? "");
                        table.Cell().Element(Cell).Text(t.Statement ?? "");
                        table.Cell().Element(Cell).Text(t.SolutionIdea ?? "");
                        table.Cell().Element(Cell).Text(t.PolygonUrl ?? "");
                        table.Cell().Element(Cell).Text(t.IsPreparedCF ? "Да" : "Нет");
                        table.Cell().Element(Cell).Text(t.IsPreparedYandex ? "Да" : "Нет");
                        table.Cell().Element(Cell).Text(t.Difficulty?.ToString() ?? "");
                        table.Cell().Element(Cell).Text(t.Notes ?? "");
                        table.Cell().Element(Cell).Text(t.Tags ?? "—");
                        table.Cell().Element(Cell).Text(t.Contexts ?? "—");
                    }
                });
            });
        });

        doc.GeneratePdf(ms);

        await JS.InvokeVoidAsync(
            "PdfSaver.savePdf",
            "tasks_report.pdf",
            Convert.ToBase64String(ms.ToArray())
        );
    }

    private IContainer CellStyle(IContainer x) =>
        x.Padding(4).BorderBottom(1).BorderColor("#cccccc");
    private void ToggleTag(int idTag)
    {
        if (SelectedTags.Contains(idTag))
            SelectedTags.Remove(idTag);
        else
            SelectedTags.Add(idTag);
    }
    private bool IsTagsOpen = false;

    private void ToggleTags()
    {
        IsTagsOpen = !IsTagsOpen;
    }

    private void CloseTags()
    {
        IsTagsOpen = false;
    }

    private bool IsAdmin;

    protected override async Task OnInitializedAsync()
    {
        // получить токен администратора
        var token = await JS.InvokeAsync<string>("sessionStorage.getItem", "is_admin");
        IsAdmin = (token == "1");

        // теперь загружаем данные
        await LoadRefsAsync();
        await LoadTasksAsync();
    }


    //фильтрация
    private async Task ApplyFilters()
    {
        await LoadTasksAsync();

        //строковый фильтр
        if (!string.IsNullOrWhiteSpace(FilterText))
        {
            string f = FilterText.ToLower();
            Tasks_ = Tasks_.Where(t =>
                (t.Name?.ToLower().Contains(f) ?? false)
                || (t.Statement?.ToLower().Contains(f) ?? false)
            ).ToList();
        }
        // фильтр по тегу
        if (SelectedTags.Count > 0)
        {
            Tasks_ = Tasks_
                .Where(t =>
                {
                    if (string.IsNullOrWhiteSpace(t.Tags))
                        return false;

                    // "tag1, tag2, tag3" -> ["tag1", "tag2", "tag3"]
                    var taskTags = t.Tags
                        .Split(',', StringSplitOptions.RemoveEmptyEntries)
                        .Select(x => x.Trim().ToLower())
                        .ToList();

                    // задача должна содержать все выбранные теги
                    return SelectedTags.Any(tagId =>
                    {
                        var tagName = Tags.First(x => x.IdTag == tagId).Name.ToLower();
                        return taskTags.Contains(tagName);
                    });

                })
                .ToList();
        }




        //фильтр по контексту
        if (FilterContext != 0)
        {
            var name = Contests.First(x => x.IdContest == FilterContext).Name;
            Tasks_ = Tasks_.Where(t =>
                !string.IsNullOrEmpty(t.Contexts)
                && t.Contexts.Split(", ").Contains(name)
            ).ToList();

        }

        //фильтр по сложности
        if (FilterDifficulty != 0)
        {
            Tasks_ = Tasks_.Where(n => n.Difficulty == FilterDifficulty).ToList();
        }

        StateHasChanged();
    }

    private async Task ResetFilters()
    {
        FilterText = "";
        FilterTag = 0;
        FilterContext = 0;
        FilterDifficulty = 0;
        await LoadTasksAsync();
        StateHasChanged();
    }

    private async Task LoadRefsAsync()
    {
        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        //теги
        {
            string sql = "SELECT id_tag, name_tag FROM tags ORDER BY name_tag";
            using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
            using var r = await cmd.ExecuteReaderAsync();

            Tags.Clear();
            while (await r.ReadAsync())
                Tags.Add(new TagRef
                {
                    IdTag = r.GetInt32(0),
                    Name = r.GetString(1)
                });

            r.Close();
        }

        //контесты
        {
            string sql = "SELECT id_contest, name_contest FROM contests ORDER BY name_contest";
            using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
            using var r = await cmd.ExecuteReaderAsync();

            Contests.Clear();
            while (await r.ReadAsync())
                Contests.Add(new ContestRef
                {
                    IdContest = r.GetInt32(0),
                    Name = r.GetString(1)
                });
        }
    }

    private void GoToCreateTask()
    {
        Nav.NavigateTo("/tasks/edit/0");
    }

    //задачи
    private async Task LoadTasksAsync()
    {
        Tasks_ = new();

        using var conn = Db.GetConnection();
        await conn.OpenAsync();

        string sql = @"
            SELECT
    t.id_task,
    t.name,
    t.statement,
    t.solution_idea,
    t.polygon_url,
    t.is_prepared_for_codeforces,
    t.is_prepared_for_yandex,
    t.difficulty,
    t.notes,
    COALESCE(string_agg(DISTINCT tg.name_tag, ', '), '') AS tags,
    COALESCE(string_agg(DISTINCT c.name_contest, ', '), '') AS contexts
FROM tasks t
LEFT JOIN task_tags tt ON t.id_task = tt.id_task
LEFT JOIN tags tg ON tg.id_tag = tt.id_tag
LEFT JOIN task_contests tc ON t.id_task = tc.id_task
LEFT JOIN contests c ON c.id_contest = tc.id_contest
GROUP BY t.id_task
ORDER BY t.id_task;

        ";

        using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
        using var reader = await cmd.ExecuteReaderAsync();

        while (await reader.ReadAsync())
        {
            Tasks_.Add(new TaskItem
            {
                IdTask = reader.GetInt32(0),
                Name = reader.IsDBNull(1) ? "" : reader.GetString(1),
                Statement = reader.IsDBNull(2) ? "" : reader.GetString(2),
                SolutionIdea = reader.IsDBNull(3) ? "" : reader.GetString(3),
                PolygonUrl = reader.IsDBNull(4) ? "" : reader.GetString(4),
                IsPreparedCF = !reader.IsDBNull(5) && reader.GetBoolean(5),
                IsPreparedYandex = !reader.IsDBNull(6) && reader.GetBoolean(6),
                Difficulty = reader.IsDBNull(7) ? null : reader.GetInt32(7),
                Notes = reader.IsDBNull(8) ? "" : reader.GetString(8),
                Tags = reader.IsDBNull(9) ? "" : reader.GetString(9),
                Contexts = reader.IsDBNull(10) ? "" : reader.GetString(10)

            });
        }
        //сложность
        if (Tasks_ != null)
        {
            foreach (var dif in Tasks_)
            {
                if (!Difficulty.Contains(dif.Difficulty) && dif.Difficulty != 0)
                {
                    Difficulty.Add(dif.Difficulty);
                }
            }

            Difficulty.Sort();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Tasks_ == null)
            return;

        foreach (var t in Tasks_)
            await JS.InvokeVoidAsync("TasksInterop.bindRowEventsById", t.IdTask);

        if (selfObj is null)
            selfObj = DotNetObjectReference.Create(this);

        await JS.InvokeVoidAsync("TasksInterop.setComponent", selfObj);
    }

    //JS

    private bool IsEditing = false;

    [JSInvokable]
    public void StartEdit()
    {
        IsEditing = true;
    }
    [JSInvokable]
    public void RequestTaskEdit(int id)
    {
        Nav.NavigateTo($"/tasks/edit/{id}");
    }

    [JSInvokable]
    public async Task RequestTaskDelete(int id)
    {
        if (IsAdmin)
            await DeleteTask(id);
    }

    [JSInvokable]
    public async Task JsLoadTasksAsync()
    {
        if (IsAdmin)
            await LoadTasksAsync();
    }

    //удаление
    public async Task DeleteTask(int id)
    {
        try
        {
            using var conn = Db.GetConnection();
            await conn.OpenAsync();

            string checkSql = "SELECT COUNT(*) FROM tasks WHERE id_task = :id";
            using (var checkCmd = new Npgsql.NpgsqlCommand(checkSql, conn))
            {
                checkCmd.Parameters.AddWithValue("id", id);
                int exists = Convert.ToInt32(await checkCmd.ExecuteScalarAsync());

                if (exists == 0)
                {
                    return;
                }
            }

            string sql = "DELETE FROM tasks WHERE id_task = :id";

            using var cmd = new Npgsql.NpgsqlCommand(sql, conn);  
            cmd.Parameters.AddWithValue("id", id);               

            await cmd.ExecuteNonQueryAsync();                     

            await LoadTasksAsync();                               
            await InvokeAsync(StateHasChanged);                  

        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine(ex.Message);
            throw;
        }
    }
}

