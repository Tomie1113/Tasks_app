@page "/tasks"
@using QuestPDF.Fluent
@using QuestPDF.Infrastructure
@using QuestPDF.Helpers

@inject Database Db
@inject AdminSession Admin
@inject IJSRuntime JS
@inject NavigationManager Nav


<div class="x-container">

    <h1 style="text-align:center; width:100%;">Задачи</h1>
    <div class="filters-panel">

        <div class="filters-row">

            <div class="filter-block">
                <label class="filter-label">Поиск</label>
                <input @bind="FilterText"
                       type="text"
                       placeholder="Название / условие"
                       class="filter-input filter-name" />

            </div>

            <div class="filter-block">
                <label class="filter-label">Тег</label>
                <select @bind="FilterTag" class="filter-input">
                    <option value="0">Все теги</option>
                    @foreach (var t in Tags)
                    {
                        <option value="@t.IdTag">@t.Name</option>
                    }
                </select>
            </div>

            <div class="filter-block">
                <label class="filter-label">Контекст</label>
                <select @bind="FilterContext" class="filter-input">
                    <option value="0">Все контексты</option>
                    @foreach (var c in Contests)
                    {
                        <option value="@c.IdContest">@c.Name</option>
                    }
                </select>
            </div>

            <div class="filter-buttons">
                <button @onclick="ApplyFilters" class="btn-primary">Фильтровать</button>
                <button @onclick="ResetFilters" class="btn-secondary">Сбросить</button>
            </div>

        </div>

    </div>


    @if (Tasks_ == null)
    {
        <p>Загрузка...</p>
    }
    else if (Tasks_.Count == 0)
    {
        <p>Задачи отсутствуют.</p>
    }
    else
    {
        <div class="table-scroll">
        <table class="x-table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Условие</th>
                    <th>Идея</th>
                    <th>Polygon</th>
                    <th>CF</th>
                    <th>Yandex</th>
                    <th>Сложность</th>
                    <th>Заметки</th>
                    <th>Теги</th>
                    <th>Контекст</th>
                </tr>
                </thead>

            <tbody>
                @foreach (var t in Tasks_)
                {
                    <tr id="task-row-@t.IdTask" @key="t.IdTask">
                        @* id на ВСЮ строку *@
                        <td>@t.Name</td>
                        <td>@t.Statement</td>
                        <td>@t.SolutionIdea</td>
                        <td>@t.PolygonUrl</td>
                        <td>@t.IsPreparedCF</td>
                        <td>@t.IsPreparedYandex</td>
                        <td>@t.Difficulty</td>
                        <td>@t.Notes</td>
                        <td>@(string.IsNullOrEmpty(t.Tags) ? "—" : t.Tags)</td>
                        <td>@(string.IsNullOrEmpty(t.Contexts) ? "—" : t.Contexts)</td>
                    </tr>
                }
            </tbody>



        </table>
                </div>
    }

    @if (Admin.IsAdmin)
    {
        <div class="filter-buttons">

            <button @onclick="GoToCreateTask">Добавить задачу</button>
            <button @onclick="ExportTasksToPdf">Экспорт в PDF</button>
        </div>
    }
    <div id="task-delete-dialog"
         style="display:none; position:fixed; inset:0;
            background:rgba(0,0,0,0.45); backdrop-filter:blur(4px);
            align-items:center; justify-content:center; z-index:9999;">

        <div style="background:var(--surface); padding:20px; border-radius:12px; width:260px;
                font-family:var(--font-main); text-align:center;
                border:1px solid var(--surface-border); backdrop-filter:blur(16px);">

            <div style="margin-bottom:15px; font-size:var(--fs-table); color:var(--grey-50);">
                Удалить задачу?
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">

                <button id="task-del-yes"
                        style="padding:10px 14px; border-radius:6px; cursor:pointer;
                           background: linear-gradient(90deg, #7a3a3a, #8c2f2f);
                           border: 1px solid rgba(200, 80, 80, 0.25);
                           color: var(--grey-50); font-size: var(--fs-table); font-weight: var(--fw-bold);
                           transition: 0.25s var(--ease-1);">
                    Удалить
                </button>

                <button id="task-del-no"
                        style="padding:10px 14px; border-radius:6px; cursor:pointer;
                           background: rgba(255,255,255,0.05);
                           border: 1px solid rgba(255,255,255,0.12);
                           color: var(--grey-200); font-size: var(--fs-table); font-weight: var(--fw-medium);
                           transition: 0.25s var(--ease-1);">
                    Отмена
                </button>

            </div>
        </div>
    </div>


</div>

@code {
    private HashSet<int> SelectedContexts = new();

    private string FilterText = "";
    private int FilterTag = 0;
    private int FilterContext = 0;

    // -----------------------------
    // MODELS
    // -----------------------------

    private DotNetObjectReference<Tasks> selfObj; // ссылка на компонент для JS

    private NewTaskModel NewTask = new(); // модель новой задачи
    private HashSet<int> SelectedTags = new(); // выбранные теги (IdTag)

    public class NewTaskModel
    {
        public string Name { get; set; } = ""; // название задачи
        public string Statement { get; set; } = ""; // условие
        public string SolutionIdea { get; set; } = ""; // идея решения
        public string PolygonUrl { get; set; } = ""; // ссылка на polygon
        public bool IsCF { get; set; } // подготовлена для CF
        public bool IsYandex { get; set; } // подготовлена для Yandex
        public int Difficulty { get; set; } // сложность 1-10
        public string Notes { get; set; } = ""; // примечание
        public int IdContext { get; set; } // выбранный контест
    }

    public class TaskItem
    {
        public int IdTask { get; set; } // ID задачи
        public string Name { get; set; } = ""; // название
        public string Statement { get; set; } = ""; // условие
        public string SolutionIdea { get; set; } = ""; // идея
        public string PolygonUrl { get; set; } = ""; // polygon URL
        public bool IsPreparedCF { get; set; } // подготовлено CF
        public bool IsPreparedYandex { get; set; } // подготовлено Yandex
        public int? Difficulty { get; set; } // сложность
        public string Notes { get; set; } = ""; // заметки
        public string Tags { get; set; } = ""; // перечисление тегов
        public string Contexts { get; set; } = "";

    }

    public class TagRef
    {
        public int IdTag { get; set; } // ID тега
        public string Name { get; set; } = ""; // название тега
    }

    public class ContestRef
    {
        public int IdContest { get; set; } // ID контеста
        public string Name { get; set; } = ""; // название контеста
    }

    private void OnContextToggle(int ctxId, bool isChecked)
    {
        if (isChecked)
            SelectedContexts.Add(ctxId);
        else
            SelectedContexts.Remove(ctxId);
    }

    private List<TagRef> Tags = new(); // список доступных тегов
    private List<ContestRef> Contests = new(); // список контестов
    private List<TaskItem>? Tasks_; // текущие задачи

    private async Task SavePdf()
    {
        if (Tasks_ == null || Tasks_.Count == 0)
            return;

        var html = new System.Text.StringBuilder();

        html.Append("<h2>Отчёт по задачам</h2>");
        html.Append("<table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse; width:100%;'>");

        html.Append("<tr>");
        html.Append("<th>Название</th>");
        html.Append("<th>Условие</th>");
        html.Append("<th>Теги</th>");
        html.Append("<th>Контекст</th>");
        html.Append("<th>Сложность</th>");
        html.Append("</tr>");

        foreach (var t in Tasks_)
        {
            html.Append("<tr>");
            html.Append($"<td>{t.Name}</td>");
            html.Append($"<td>{t.Statement}</td>");
            html.Append($"<td>{t.Tags}</td>");
            html.Append($"<td>{t.Contexts}</td>");

            html.Append($"<td>{t.Difficulty}</td>");
            html.Append("</tr>");
        }

        html.Append("</table>");

        var bytes = System.Text.Encoding.UTF8.GetBytes(html.ToString());

        var base64 = Convert.ToBase64String(bytes);

        await JS.InvokeVoidAsync("downloadFile", "report.pdf", base64);
    }

    public Tasks()
    {
        QuestPDF.Settings.License = LicenseType.Community;
    }

    public async Task ExportTasksToPdf()
    {
        if (Tasks_ == null || Tasks_.Count == 0)
            return;

        using var ms = new MemoryStream();

        var doc = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Margin(20);
                page.Size(PageSizes.A4.Landscape());   // ← АЛЬБОМНАЯ ОРИЕНТАЦИЯ

                // ----- ЗАГОЛОВОК СТРАНИЦЫ -----
                page.Header()
                    .PaddingBottom(10)                  // отступ под заголовком (на КОНТЕЙНЕРЕ)
                    .AlignCenter()                      // выравнивание по центру (на КОНТЕЙНЕРЕ)
                    .Text("Отчёт по задачам")           // сам текст заголовка
                        .FontSize(18)                   // размер шрифта
                        .Bold();                        // жирный

                page.Content().Table(table =>
                {
                    // --- КОЛОНКИ ---
                    table.ColumnsDefinition(columns =>
                    {
                        columns.RelativeColumn(2);  // Название
                        columns.RelativeColumn(3);  // Условие
                        columns.RelativeColumn(3);  // Идея
                        columns.RelativeColumn(2);  // Polygon
                        columns.RelativeColumn(1);  // CF
                        columns.RelativeColumn(1);  // Yandex
                        columns.RelativeColumn(1);  // Сложность
                        columns.RelativeColumn(2);  // Заметки
                        columns.RelativeColumn(2);  // Теги
                        columns.RelativeColumn(2);  // Контексты
                    });

                    // ---- СТИЛЬ ЯЧЕЙКИ ТАБЛИЦЫ ----
                    IContainer Cell(IContainer container) =>
                        container
                            .Border(0.5f)
                            .BorderColor("#000")
                            .Padding(4);

                    // ---- ШАПКА ----
                    table.Header(header =>
                    {
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Название").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Условие").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Идея решения").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Polygon URL").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("CF").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Yandex").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Сложность").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Заметки").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Теги").Bold();
                        header.Cell().Element(Cell).Background("#e5e5e5").Text("Контексты").Bold();
                    });

                    // ---- ДАННЫЕ ----
                    foreach (var t in Tasks_)
                    {
                        table.Cell().Element(Cell).Text(t.Name ?? "");
                        table.Cell().Element(Cell).Text(t.Statement ?? "");
                        table.Cell().Element(Cell).Text(t.SolutionIdea ?? "");
                        table.Cell().Element(Cell).Text(t.PolygonUrl ?? "");
                        table.Cell().Element(Cell).Text(t.IsPreparedCF ? "Да" : "Нет");
                        table.Cell().Element(Cell).Text(t.IsPreparedYandex ? "Да" : "Нет");
                        table.Cell().Element(Cell).Text(t.Difficulty?.ToString() ?? "");
                        table.Cell().Element(Cell).Text(t.Notes ?? "");
                        table.Cell().Element(Cell).Text(t.Tags ?? "—");
                        table.Cell().Element(Cell).Text(t.Contexts ?? "—");
                    }
                });
            });
        });

        doc.GeneratePdf(ms);

        await JS.InvokeVoidAsync(
            "PdfSaver.savePdf",
            "tasks_report.pdf",
            Convert.ToBase64String(ms.ToArray())
        );
    }



    // public async Task ExportTasksToPdf()
    // {
    //     if (Tasks_ == null || Tasks_.Count == 0)
    //         return;

    //     string outputPath = Path.Combine(
    //         Environment.GetFolderPath(Environment.SpecialFolder.Desktop),
    //         "tasks_report.pdf"
    //     );

    //     var doc = Document.Create(container =>
    //     {
    //         container.Page(page =>
    //         {
    //             page.Margin(25);
    //             page.Size(PageSizes.A4);
    //             page.Content().Table(table =>
    //             {
    //                 // ОПРЕДЕЛЯЕМ КОЛОНКИ
    //                 table.ColumnsDefinition(col =>
    //                 {
    //                     col.RelativeColumn(2); // Название
    //                     col.RelativeColumn(3); // Условие
    //                     col.RelativeColumn(2); // Идея
    //                     col.RelativeColumn(2); // Tags
    //                     col.RelativeColumn(2); // Context
    //                 });

    //                 // ШАПКА
    //                 table.Header(header =>
    //                 {
    //                     header.Cell().Text("Название").Bold();
    //                     header.Cell().Text("Условие").Bold();
    //                     header.Cell().Text("Идея").Bold();
    //                     header.Cell().Text("Теги").Bold();
    //                     header.Cell().Text("Контекст").Bold();
    //                 });

    //                 // СТРОКИ
    //                 foreach (var t in Tasks_)
    //                 {
    //                     table.Cell().Text(t.Name ?? "");
    //                     table.Cell().Text(t.Statement ?? "");
    //                     table.Cell().Text(t.SolutionIdea ?? "");
    //                     table.Cell().Text(t.Tags ?? "—");
    //                     table.Cell().Text(t.Contexts ?? "—");

    //                 }
    //             });
    //         });
    //     });

    //     doc.GeneratePdf(outputPath);
    // }



    // -----------------------------
    // ЕДИНЫЙ стиль ячейки
    // -----------------------------
    private IContainer CellStyle(IContainer x) =>
        x.Padding(4).BorderBottom(1).BorderColor("#cccccc");


    // -----------------------------
    // INIT
    // -----------------------------
    protected override async Task OnInitializedAsync()
    {
        await LoadRefsAsync(); // загрузка тегов и контестов
        await LoadTasksAsync(); // загрузка задач
    }

    private async Task ApplyFilters()
    {
        await LoadTasksAsync(); // перезагружаем задачи

        // строковый фильтр
        if (!string.IsNullOrWhiteSpace(FilterText))
        {
            string f = FilterText.ToLower();
            Tasks_ = Tasks_.Where(t =>
                (t.Name?.ToLower().Contains(f) ?? false)
                || (t.Statement?.ToLower().Contains(f) ?? false)
            ).ToList();
        }

        // фильтр по тегу
        if (FilterTag != 0)
        {
            Tasks_ = Tasks_.Where(t =>
                !string.IsNullOrEmpty(t.Tags)
                && t.Tags.Split(", ").Contains(
                    Tags.First(x => x.IdTag == FilterTag).Name
                )
            ).ToList();
        }

        // фильтр по контексту
        if (FilterContext != 0)
        {
            var name = Contests.First(x => x.IdContest == FilterContext).Name;
            Tasks_ = Tasks_.Where(t =>
                !string.IsNullOrEmpty(t.Contexts)
                && t.Contexts.Split(", ").Contains(name)
            ).ToList();

        }

        StateHasChanged();
    }

    private async Task ResetFilters()
    {
        FilterText = "";
        FilterTag = 0;
        FilterContext = 0;
        await LoadTasksAsync(); // полный список
        StateHasChanged();
    }

    // -----------------------------
    // LOAD REF TABLES
    // -----------------------------
    private async Task LoadRefsAsync()
    {
        using var conn = Db.GetConnection(); // создаём подключение
        await conn.OpenAsync(); // открываем подключение

        // TAGS
        {
            string sql = "SELECT id_tag, name_tag FROM tags ORDER BY name_tag"; // SQL для тегов
            using var cmd = new Npgsql.NpgsqlCommand(sql, conn); // создаём команду
            using var r = await cmd.ExecuteReaderAsync(); // выполняем запрос

            Tags.Clear(); // очищаем список тегов
            while (await r.ReadAsync()) // читаем строки
                Tags.Add(new TagRef
                {
                    IdTag = r.GetInt32(0), // id_tag
                    Name = r.GetString(1) // name_tag
                });

            r.Close(); // закрываем reader
        }

        // CONTESTS
        {
            string sql = "SELECT id_contest, name_contest FROM contests ORDER BY name_contest"; // SQL для контестов
            using var cmd = new Npgsql.NpgsqlCommand(sql, conn); // команда
            using var r = await cmd.ExecuteReaderAsync(); // reader

            Contests.Clear(); // очищаем список контестов
            while (await r.ReadAsync()) // читаем строки
                Contests.Add(new ContestRef
                {
                    IdContest = r.GetInt32(0), // id_contest
                    Name = r.GetString(1) // name_contest
                });
        }
    }
    private void GoToCreateTask()
    {
        // 0 трактуем как "новая задача"
        Nav.NavigateTo("/tasks/edit/0");
    }

    // -----------------------------
    // LOAD TASKS
    // -----------------------------
    private async Task LoadTasksAsync()
    {
        Tasks_ = new(); // создаём список задач

        using var conn = Db.GetConnection(); // подключение
        await conn.OpenAsync(); // открываем

        string sql = @"
            SELECT
    t.id_task,
    t.name,
    t.statement,
    t.solution_idea,
    t.polygon_url,
    t.is_prepared_for_codeforces,
    t.is_prepared_for_yandex,
    t.difficulty,
    t.notes,
    COALESCE(string_agg(DISTINCT tg.name_tag, ', '), '') AS tags,
    COALESCE(string_agg(DISTINCT c.name_contest, ', '), '') AS contexts
FROM tasks t
LEFT JOIN task_tags tt ON t.id_task = tt.id_task
LEFT JOIN tags tg ON tg.id_tag = tt.id_tag
LEFT JOIN task_contests tc ON t.id_task = tc.id_task
LEFT JOIN contests c ON c.id_contest = tc.id_contest
GROUP BY t.id_task
ORDER BY t.id_task;

        "; // SQL с агрегацией тегов

        using var cmd = new Npgsql.NpgsqlCommand(sql, conn); // команда
        using var reader = await cmd.ExecuteReaderAsync(); // reader

        while (await reader.ReadAsync()) // читаем строки
        {
            Tasks_.Add(new TaskItem
            {
                IdTask = reader.GetInt32(0), // id_task
                Name = reader.IsDBNull(1) ? "" : reader.GetString(1),
                Statement = reader.IsDBNull(2) ? "" : reader.GetString(2),
                SolutionIdea = reader.IsDBNull(3) ? "" : reader.GetString(3),
                PolygonUrl = reader.IsDBNull(4) ? "" : reader.GetString(4),
                IsPreparedCF = !reader.IsDBNull(5) && reader.GetBoolean(5),
                IsPreparedYandex = !reader.IsDBNull(6) && reader.GetBoolean(6),
                Difficulty = reader.IsDBNull(7) ? null : reader.GetInt32(7),
                Notes = reader.IsDBNull(8) ? "" : reader.GetString(8),
                Tags = reader.IsDBNull(9) ? "" : reader.GetString(9),
                Contexts = reader.IsDBNull(10) ? "" : reader.GetString(10)

            });
        }
    }

    // -----------------------------
    // TAG CHECKBOX HANDLER
    // -----------------------------
    private void OnTagToggle(int tagId, bool isChecked)
    {
        if (isChecked) // если включили чекбокс
            SelectedTags.Add(tagId); // добавляем тег
        else
            SelectedTags.Remove(tagId); // убираем тег
    }

    // -----------------------------
    // ADD TASK (WITH TAGS)
    // -----------------------------
private async Task AddTask()
{
    System.Diagnostics.Debug.WriteLine("======================================");
    System.Diagnostics.Debug.WriteLine("[Tasks] >>> НАЧАТЬ ДОБАВЛЕНИЕ ЗАДАЧИ");
    System.Diagnostics.Debug.WriteLine("======================================");

    try
    {
        System.Diagnostics.Debug.WriteLine($"[Tasks] Name = '{NewTask.Name}'");
        System.Diagnostics.Debug.WriteLine($"[Tasks] Statement length = {NewTask.Statement?.Length}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] SolutionIdea length = {NewTask.SolutionIdea?.Length}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] PolygonUrl = '{NewTask.PolygonUrl}'");
        System.Diagnostics.Debug.WriteLine($"[Tasks] IsCF = {NewTask.IsCF}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] IsYandex = {NewTask.IsYandex}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] Difficulty = {NewTask.Difficulty}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] Notes length = {NewTask.Notes?.Length}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] SelectedTags = {string.Join(",", SelectedTags)}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] SelectedContexts = {string.Join(",", SelectedContexts)}");

        using var conn = Db.GetConnection();
        await conn.OpenAsync();
        System.Diagnostics.Debug.WriteLine("[Tasks] Подключение к БД ОК");

        string sql = @"
            INSERT INTO tasks
            (name, statement, solution_idea, polygon_url,
             is_prepared_for_codeforces, is_prepared_for_yandex,
             difficulty, notes, id_context)
            VALUES
            (:n, :st, :si, :p, :cf, :ya, :d, :no, :ctx)
            RETURNING id_task;
        ";

        System.Diagnostics.Debug.WriteLine($"[Tasks] SQL INSERT: {sql}");

        int newId;

        using (var cmd = new Npgsql.NpgsqlCommand(sql, conn))
        {
            cmd.Parameters.AddWithValue("n", NewTask.Name);
            cmd.Parameters.AddWithValue("st", NewTask.Statement);
            cmd.Parameters.AddWithValue("si", NewTask.SolutionIdea);
            cmd.Parameters.AddWithValue("p", NewTask.PolygonUrl);
            cmd.Parameters.AddWithValue("cf", NewTask.IsCF);
            cmd.Parameters.AddWithValue("ya", NewTask.IsYandex);
            cmd.Parameters.AddWithValue("d", NewTask.Difficulty);
            cmd.Parameters.AddWithValue("no", NewTask.Notes);
            cmd.Parameters.AddWithValue("ctx",
                NewTask.IdContext == 0 ? DBNull.Value : NewTask.IdContext);

            newId = Convert.ToInt32(await cmd.ExecuteScalarAsync());
        }

        System.Diagnostics.Debug.WriteLine($"[Tasks] SQL INSERT выполнен, newId = {newId}");

        // ТЕГИ
        System.Diagnostics.Debug.WriteLine("[Tasks] Вставка тегов...");
        foreach (var tagId in SelectedTags)
        {
            string sqlTag = @"INSERT INTO task_tags (id_task, id_tag) VALUES (:t, :g)";
            System.Diagnostics.Debug.WriteLine($"[Tasks] SQL TAG INSERT: {sqlTag}  (task={newId}, tag={tagId})");

            using var tagCmd = new Npgsql.NpgsqlCommand(sqlTag, conn);
            tagCmd.Parameters.AddWithValue("t", newId);
            tagCmd.Parameters.AddWithValue("g", tagId);
            await tagCmd.ExecuteNonQueryAsync();
        }

        // КОНТЕКСТЫ
        System.Diagnostics.Debug.WriteLine("[Tasks] Вставка контекстов...");
        foreach (var ctxId in SelectedContexts)
        {
            string sqlCtx = @"INSERT INTO task_contests (id_task, id_contest) VALUES (:t, :c)";
            System.Diagnostics.Debug.WriteLine($"[Tasks] SQL CTX INSERT: {sqlCtx}  (task={newId}, ctx={ctxId})");

            using var ctxCmd = new Npgsql.NpgsqlCommand(sqlCtx, conn);
            ctxCmd.Parameters.AddWithValue("t", newId);
            ctxCmd.Parameters.AddWithValue("c", ctxId);
            await ctxCmd.ExecuteNonQueryAsync();
        }

        // Обновление
        System.Diagnostics.Debug.WriteLine("[Tasks] Перезагружаем задачи...");
        await LoadTasksAsync();

        NewTask = new();
        SelectedTags.Clear();
        SelectedContexts.Clear();

        StateHasChanged();

        System.Diagnostics.Debug.WriteLine("======================================");
        System.Diagnostics.Debug.WriteLine("[Tasks] >>> ДОБАВЛЕНИЕ ЗАДАЧИ ЗАВЕРШЕНО");
        System.Diagnostics.Debug.WriteLine("======================================");
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
        System.Diagnostics.Debug.WriteLine("[Tasks] ОШИБКА ПРИ ДОБАВЛЕНИИ ЗАДАЧИ");
        System.Diagnostics.Debug.WriteLine($"[Tasks] Тип: {ex.GetType()}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] Сообщение: {ex.Message}");
        System.Diagnostics.Debug.WriteLine($"[Tasks] StackTrace: {ex.StackTrace}");
        System.Diagnostics.Debug.WriteLine("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");

        throw;
    }
}

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Tasks_ == null)
            return;

        // 1) Всегда вешаем события на строки задач
        foreach (var t in Tasks_)
            await JS.InvokeVoidAsync("TasksInterop.bindRowEventsById", t.IdTask);

        // 2) Гарантированно один раз создаём ссылку на компонент
        if (selfObj is null)
            selfObj = DotNetObjectReference.Create(this);

        // 3) И каждый рендер пробуем привязать компонент к JS
        //    (если скрипт ещё не загрузился — просто упадёт 1 раз, потом заработает)
        await JS.InvokeVoidAsync("TasksInterop.setComponent", selfObj);
    }


    // ---------- JS CALLBACKS -----------

    private bool IsEditing = false;

    [JSInvokable]
    public void StartEdit()
    {
        IsEditing = true;
    }
    [JSInvokable]
    public void RequestTaskEdit(int id)
    {
        System.Diagnostics.Debug.WriteLine($"[Tasks] >>> ПЕРЕХОД НА РЕДАКТИРОВАНИЕ ЗАДАЧИ ID={id}");
        Nav.NavigateTo($"/tasks/edit/{id}"); // открываем форму редактирования
    }

    [JSInvokable]
    public async Task RequestTaskDelete(int id)
    {
        System.Diagnostics.Debug.WriteLine($"[Tasks] >>> НАЧАТЬ УДАЛЕНИЕ ЗАДАЧИ ID={id}");  // старт
        System.Diagnostics.Debug.WriteLine("======================================");        // разделитель

        if (Admin.IsAdmin)
            await DeleteTask(id);

    }

    [JSInvokable]
    public async Task RequestTaskRename(int id, string newElem, string type)
    {
        if (Admin.IsAdmin)
            await RenameTask(id, newElem, GetRenameTaskType(type));
    }

    [JSInvokable]
    public async Task JsLoadTasksAsync()
    {
        if (Admin.IsAdmin)
            await LoadTasksAsync();
    }


    // ---------- RENAME ----------

    public enum RenameTaskType
    {
        Name,
        Statement,
        SolutionIdea,
        PolygonUrl,
        IsPreparedCf,
        IsPreparedYandex,
        Difficulty,
        Notes
        //Tag,
        //Contest

    }

    private RenameTaskType GetRenameTaskType(string type)
    {
        return type switch
        {
            "name" => RenameTaskType.Name,
            "statement" => RenameTaskType.Statement,
            "solutionIdea" => RenameTaskType.SolutionIdea,
            "polygonUrl" => RenameTaskType.PolygonUrl,
            "isPreparedCf" => RenameTaskType.IsPreparedCf,
            "isPreparedYandex" => RenameTaskType.IsPreparedYandex,
            "difficulty" => RenameTaskType.Difficulty,
            "notes" => RenameTaskType.Notes,
            //"tag" => RenameTaskType.Tag,
            //"contest" => RenameTaskType.Contest,
            _ => throw new Exception()
        };
    }

    public async Task RenameTask(int id, string value, RenameTaskType type)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            await JS.InvokeVoidAsync("alert", "Название не может быть пустым");
            return;
        }

        await using var conn = Db.GetConnection();
        await conn.OpenAsync();

        NpgsqlCommand cmd;
        switch (type)
        {
            case RenameTaskType.Name:
                var sql = "UPDATE tasks SET name = :name WHERE id_task = :id";

                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("name", value);
                break;
            case RenameTaskType.Statement:
                sql = "UPDATE tasks SET statement = :statement WHERE id_task = :id";

                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("statement", value);
                break;
            case RenameTaskType.SolutionIdea:
                sql = "UPDATE tasks SET solution_idea = :solutionIdea WHERE id_task = :id";

                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("solutionIdea", value);
                break;
            case RenameTaskType.PolygonUrl:
                sql = "UPDATE tasks SET polygon_url = :polygonUrl WHERE id_task = :id";

                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("polygonUrl", value);
                break;
            case RenameTaskType.IsPreparedCf:
                sql = "UPDATE tasks SET is_prepared_for_codeforces = :isPreparedCf WHERE id_task = :id";

                //bool
                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("isPreparedCf", value);
                break;
            case RenameTaskType.IsPreparedYandex:
                sql = "UPDATE tasks SET is_prepared_for_codeforces = :isPreparedYandex WHERE id_task = :id";

                //bool
                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("isPreparedYandex", value);
                break;
            case RenameTaskType.Difficulty:
                sql = "UPDATE tasks SET difficulty = :difficulty WHERE id_task = :id";

                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                int intValue;
                if (!int.TryParse(value, out intValue))
                    throw new Exception("Year was not a number!");
                cmd.Parameters.AddWithValue("difficulty", intValue);
                break;
            case RenameTaskType.Notes:
                sql = "UPDATE tasks SET notes = :notes WHERE id_task = :id";

                cmd = new Npgsql.NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("notes", value);
                break;


            //изменение тегов и контестов по-другому должно быть


            /*
        case RenameTaskType.Tag:
            sql = "UPDATE tasks SET Tag = :Tag WHERE id_contest = :id";

            cmd = new Npgsql.NpgsqlCommand(sql, conn);
            if (!int.TryParse(value, out intValue))
                throw new Exception("Year was not a number!");
            cmd.Parameters.AddWithValue("Tag", intValue);
            break;
        case RenameTaskType.Contest:
            sql = "UPDATE tasks SET Contest = :Contest WHERE id_contest = :id";

            cmd = new Npgsql.NpgsqlCommand(sql, conn);
            if (!int.TryParse(value, out intValue))
                throw new Exception("Year was not a number!");
            cmd.Parameters.AddWithValue("Contest", intValue);
            break;
            */
            default:
                throw new Exception();
        }

        cmd.Parameters.AddWithValue("id", id);
        await cmd.ExecuteNonQueryAsync();

        IsEditing = false; // ← НОВАЯ СТРОКА

        await LoadTasksAsync();
        await InvokeAsync(StateHasChanged);

    }





    public async Task DeleteTask(int id)
    {
        System.Diagnostics.Debug.WriteLine("======================================");
        System.Diagnostics.Debug.WriteLine("[Tasks] >>> ЗАПРОС НА УДАЛЕНИЕ ЗАДАЧИ");
        System.Diagnostics.Debug.WriteLine($"[Tasks] Входной id = {id}");
        System.Diagnostics.Debug.WriteLine("======================================");

        try
        {
            using var conn = Db.GetConnection();
            await conn.OpenAsync();
            System.Diagnostics.Debug.WriteLine("[Tasks] Подключение к БД успешно");

            // ЛОГ: Проверим, существует ли такая задача
            string checkSql = "SELECT COUNT(*) FROM tasks WHERE id_task = :id";
            using (var checkCmd = new Npgsql.NpgsqlCommand(checkSql, conn))
            {
                checkCmd.Parameters.AddWithValue("id", id);
                int exists = Convert.ToInt32(await checkCmd.ExecuteScalarAsync());
                System.Diagnostics.Debug.WriteLine($"[Tasks] Проверка существования: {exists} записей");

                if (exists == 0)
                {
                    System.Diagnostics.Debug.WriteLine("[Tasks] !!! Задача НЕ найдена, удалять нечего");
                    return;
                }
            }

            // ЛОГ: SQL удаления
            string sql = "DELETE FROM tasks WHERE id_task = :id";
            System.Diagnostics.Debug.WriteLine($"[Tasks] SQL DELETE = {sql}");

            using var cmd = new Npgsql.NpgsqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("id", id);

            int rows = await cmd.ExecuteNonQueryAsync();
            System.Diagnostics.Debug.WriteLine($"[Tasks] Удалено строк: {rows}");

            // ЛОГ: Проверка успешности
            if (rows == 0)
            {
                System.Diagnostics.Debug.WriteLine("[Tasks] !!! SQL выполнен, но 0 строк удалено");
            }
            else
            {
                System.Diagnostics.Debug.WriteLine("[Tasks] Удаление прошло успешно");
            }

            // ЛОГ: Перезагрузка списка после удаления
            System.Diagnostics.Debug.WriteLine("[Tasks] Обновляем список задач...");
            await LoadTasksAsync();
            await InvokeAsync(StateHasChanged);

            System.Diagnostics.Debug.WriteLine("[Tasks] >>> УДАЛЕНИЕ ЗАВЕРШЕНО");
            System.Diagnostics.Debug.WriteLine("======================================");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
            System.Diagnostics.Debug.WriteLine("[Tasks] ОШИБКА ПРИ УДАЛЕНИИ ЗАДАЧИ");
            System.Diagnostics.Debug.WriteLine($"[Tasks] Тип: {ex.GetType()}");
            System.Diagnostics.Debug.WriteLine($"[Tasks] Сообщение: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"[Tasks] StackTrace: {ex.StackTrace}");
            System.Diagnostics.Debug.WriteLine("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");

            throw;
        }
    }


}

